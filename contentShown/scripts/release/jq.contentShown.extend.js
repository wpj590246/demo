/******************************************
 * jq.contentShown.js
 *
 * @author          Ethan.Zhu（zhuyidong）
 * @version         Version 2.0
 * @copyright       Copyright (c) 2012 Ethan.Zhu
 * @license         This contentShown jQuery plug-in is dual licensed under the MIT and GPL licenses.
 * 
 * @docs            http://ethanzhu.github.com/jq.contentShown/
 * @demo            http://ethanzhu.github.com/jq.contentShown/img-demo.html;
 * 					http://ethanzhu.github.com/jq.contentShown/cont-demo.html
 * @email			pig.whose@gmail.com; 12377166@qq.com
 * 
 *
 ******************************************/
$.fn.extend($.contentShown,{_buildContentShown:function(target,name,value){var self=this,inst=self._getInst(target),func=self.func,nCont=self._g(inst,"nContent"),pCont=self._g(inst,"pContent"),player=self._g(inst,"player"),ptype=self._g(inst,"pType"),showTip=self._g(inst,"showTips"),tipsBtn=self._g(inst,"tipsBtn"),item=self._g(inst,"_item"),pitem=self._g(inst,"_pitem"),preLoad=self._g(inst,"preLoad"),mainData=[],mainLength,$navList,navList,$playList,playList,thisCont,$content,content,$thisNav,thisNav,$thisPlay,thisPlay,$navCont,navCont,$playCont,playCont,$thisData,$gLink,thisLink,build,$buildCont,buildCont,$buildLink,buildLink,buildHref,$h2,$h3,i,j,m,n,k;inst.build=!0,$navList=inst.$elem.find("li."+item),navList=$navList[0],$playList=inst.$elem.find("li."+pitem),playList=$playList[0];if(typeof navList=="undefined"&&typeof playList=="undefined")return;self._optionContentShown(target,name,value),preLoad?self._extendRemove(inst.settings,{preLoad:!1}):func,typeof playList!="undefined"?mainLength=$playList.length:player?(player=!1,self._extendRemove(inst.settings,{player:!1})):func,typeof navList!="undefined"?mainLength=$navList.length:nCont=="image"?self._extendRemove(inst.settings,{nContent:"none"}):func;if(typeof navList=="undefined"&&!player)return;var foramtLink=function(a){return a.charAt(a.length-1)!="/"?a+="/":func,a},buildData=function(a,b,c,d){$content=a,build=[],thisLink=typeof c[0]!="undefined"?foramtLink(c.html()):"",b!="btns"&&b!="hgroup"&&b!="other"&&(b=="content"?build.push('"'+$content.html().replace(/"/g,'\\"')+'"'):($buildLink=$content.find("a:first"),buildLink=$buildLink[0],$buildCont=$content.find("img"),buildCont=$buildCont[0],typeof buildLink!="undefined"&&(buildHref=foramtLink(buildLink.href),buildHref==thisLink?build.push('"'+buildCont.src+'"'):(build.push("{"),build.push('"t":"'+buildCont.src+'"'),build.push('"l":"'+buildLink.href+'"'),buildLink.target?build.push('"g":"'+buildLink.target+'"'):func,buildCont.alt?build.push('"a":"'+buildCont.alt+'"'):func,d!="play"?(buildCont.width?build.push('"w":"'+buildCont.width+'"'):func,buildCont.height?build.push('"h":"'+buildCont.height+'"'):func):func,build.push("}"))))),b=="hgroup"&&($buildLink=$content.find("a:first"),buildLink=$buildLink[0],typeof buildLink!="undefined"?(buildCont=$buildLink.html(),buildHref=foramtLink(buildLink.href),buildHref!=thisLink?(build.push("{"),build.push('"t":"'+buildCont+'"'),build.push('"l":"'+buildLink.href+'"'),buildLink.target?build.push('"g":"'+buildLink.target+'"'):func,build.push("}")):build.push('"'+buildCont+'"')):build.push('"'+buildCont+'"'));if(b=="btns"){$buildCont=$content.find("a");if(typeof $buildCont[0]!="undefined"){m=$buildCont.length,m==1?func:build.push("[");for(n=0;n<m;n++)build.push("{"),$buildLink=$buildCont.eq(n),buildLink=$buildLink[0],buildHref=foramtLink(buildLink.href),buildLink.className!=""?build.push('"c":"'+buildLink.className+'"'):func,buildHref!=thisLink?(build.push('"l":"'+buildLink.href+'"'),buildLink.target?build.push('"g":"'+buildLink.target+'"'):func,buildLink.title?build.push('"t":"'+buildLink.title+'"'):""):func,$buildLink.html()!=""?build.push('"t_":"'+$buildLink.html()+'"'):func,build.push("}");m==1?func:build.push("]")}else buildCont=$content.html(),buildCont!=""?build.push('"'+buildCont+'"'):""}if(b=="other"){m=$content.length,m==1?func:build.push("[");for(n=0;n<m;n++){$buildCont=$content.eq(n),$buildCont=$buildCont.find("span"),buildCont=typeof $buildCont[0]!="undefined"?$buildCont.html():"",build.push("{"),build.push('"n":"'+buildCont+'"'),$buildCont=$content.eq(n).find("a");if(typeof $buildCont[0]!="undefined"){build.push('"list":'),j=$buildCont.length,j==1?func:build.push("[");for(k=0;k<j;k++)build.push("{"),$buildLink=$buildCont.eq(k),buildLink=$buildLink[0],buildHref=foramtLink(buildLink.href),$buildLink.html()!=""?(build.push('"t":"'+$buildLink.html()+'"'),buildHref!=thisLink?(build.push('"l":"'+buildLink.href+'"'),buildLink.target?build.push('"g":"'+buildLink.target+'"'):func):func):func,build.push("}");j==1?func:build.push("]")}build.push("}")}m==1?func:build.push("]")}return build.join(",")};for(i=0;i<mainLength;i++)$gLink=null,typeof navList!="undefined"?$thisNav=$navList.eq(i):func,typeof playList!="undefined"?$thisPlay=$playList.eq(i):func,mainData.push("{"),$thisNav&&($gLink=$thisNav.find("p.global-link"),typeof $gLink[0]!="undefined"?mainData.push('"l":"'+$gLink.html()+'"'):func,$content=$thisNav.find(".this-content"),content=typeof $content[0]!="undefined"?buildData($content,nCont,$gLink):'""',mainData.push('"s":'+content)),$thisPlay&&player&&(!$gLink||typeof $gLink[0]=="undefined"?($gLink=$thisPlay.find("p.global-link"),typeof $gLink[0]!="undefined"?mainData.push('"l":"'+$gLink.html()+'"'):func):func,$content=$thisPlay.find(".this-content"),content=typeof $content[0]!="undefined"?buildData($content,pCont,$gLink,"play"):'""',mainData.push('"b":'+content),showTip&&($tips=$thisPlay.find("label"),$h2=$content.find("h2"),$content=$tips.find("h3"),typeof $thisPlay[0]!="undefined"?($content=$tips.find("h2"),content=typeof $content[0]!="undefined"?buildData($content,"hgroup",$gLink):"",content!=""?mainData.push('"t":'+content):func,$content=$tips.find("h3"),content=typeof $content[0]!="undefined"?buildData($content,"hgroup",$gLink):"",content!=""?mainData.push('"t1":'+content):func):func,$content=$tips.find(".tip-message"),typeof $content[0]!="undefined"?mainData.push('"m":"'+$content.html()+'"'):"",ptype?($content=$tips.find(".play-type"),typeof $content[0]!="undefined"?mainData.push('"tp":"'+$content.html()+'"'):func):func,tipsBtn?($content=$tips.find(".tip-btns"),content=typeof $content[0]!="undefined"?buildData($content,"btns",$gLink):"",content!=""?mainData.push('"b_":'+content):""):func,$content=$tips.find(".other-titles"),content=typeof $content[0]!="undefined"?buildData($content,"other",$gLink):"",content!=""?mainData.push('"ot":'+content):func)),mainData.push("}");mainData="["+mainData.join(",").replace(/([{\[:]),/g,"$1").replace(/,([}\]])/g,"$1")+"]",self.log(mainData),mainData=eval(mainData),inst.data=[],mainLength=mainData.length;for(i=0;i<mainLength;i++)$content=mainData[i],$.isEmptyObject($content)||inst.data.push($content);inst.data?self._instData(inst):func},_extendPyramid:function(a){var b=this,c=b._g(a,"preLoad"),d=b._g(a,"navSpace"),e,f=b._g(a,"nContent"),g=a.$navList,h=g.find("li."+b._g(a,"_item")),i,j=b.func,k,l,m=a.total,n,o,p,q,r,s,t,u,v,w,x,y=0,z;a.$extend=[],n=Math.floor((m-1)/2),o=m-1-n,p=m-n,h.each(function(b){e=$(this),a.$extend.push({$nav:e,position:null,size:null,zIndex:m}),e.css("position","absolute").css("left",b*d)}),v=a.$extend[0].$nav,a.$extend[0].size={width:v.width(),height:v.height()},a.$extend[0].zIndex=m;for(q=1;q<=o;q++)r=q-1,s=a.$extend[r],u=s.size,a.$extend[q].size={width:Math.ceil(u.width*.75),height:Math.ceil(u.height*.75)},y+=a.$extend[q].size.width-parseInt(a.$extend[q].size.width*.25),a.$extend[q].zIndex=s.zIndex-1;y=y*2+a.$extend[0].size.width,a.$navList.css("width",y),a.$extend[0].position={top:0,left:parseInt(a.$navList.width()/2-v.width()/2)};for(q=1;q<=o;q++)r=q-1,s=a.$extend[r],t=s.position,u=s.size,a.$extend[q].position={top:t.top+20,left:t.left+parseInt(u.width-a.$extend[q].size.width*.25)},q==o&&(z=a.$extend[q].size.height+a.$extend[q].position.top);a.$navList.css("height",z);for(q=m-1;q>=p;q--)r=(q+1)%m,s=a.$extend[r],t=s.position,u=s.size,a.$extend[q].size={width:Math.ceil(u.width*.75),height:Math.ceil(u.height*.75)},a.$extend[q].zIndex=s.zIndex-1,a.$extend[q].position={top:t.top+20,left:t.left-parseInt(a.$extend[q].size.width*.75)};for(q=0;q<m;q++)w=a.$extend[q],v=a.$extend[q].$nav,x=a.$extend[q].position,k=w.size.width,l=w.size.height,f==="image"?v.find("img").css({width:k,height:l}):j,v.attr("data-pyramid",v.attr("data-index")).css({left:x.left,top:x.top,width:k,height:l,"z-index":w.zIndex})},_extendNav:function(a){var b=this._g(a,"navNum");if(b==="pyramid")this._extendPyramid(a);else return},_pyramidStyle:function(a){var b=this,c=a.selected,d=a.$navList.find("li"),e=a.total,f,g,h=a.extend_,i=a.$extend,j,k;f=e-Math.floor((e-1)/2),g=d.eq(c).attr("data-pyramid"),k=(e+(g-h))%e,j=g<f?!1:!0;if(a.btnClick){a.btnClick=!1,a.$navList.undelegate();var l,m,n=0;l=(e+(j?-1:1)*(g-h))%e,m=new Array(15),m[0]=.2,m[1]=.2+.2*.81;for(var o=2,p=m[1];o<m.length;o++)m[o]=p+(p-m[o-2])*.81,p=m[o],o==m.length-1&&(m[o]=1);var q,r,s,t,u,v,w,x,y,z,A,o,B,r,C,D,E=function(){q=e;for(var c=0;c<q;c++)r=(q+c+l*(j?1:-1))%q,s=i[r],t=s.position,u=s.size.width,v=s.size.height,toZIndex=s.zIndex,w=i[c],x=w.position,y=w.size.width,z=w.size.height,A=w.zIndex,D=w.$nav,D.find("img").css({width:y+(u-y)*m[n],height:z+(v-z)*m[n]}),D.css({left:x.left+(t.left-x.left)*m[n],top:x.top+(t.top-x.top)*m[n],width:y+(u-y)*m[n]+"px",height:z+(v-z)*m[n]+"px","z-index":toZIndex});n++;if(n<m.length)setTimeout(E,30);else{n=0;for(c=0;c<q;c++)r=(q+c+l*(j?1:-1))%q,C=i[c],D=C.$nav,C.position.left=D.position().left,C.position.top=D.position().top,C.size.width=D.width(),C.size.height=D.height(),C.zIndex=D.css("z-index");a.btnClick=!0,b._navItem(a),clearTimeout(B)}};B=setTimeout(function(){E()},50),a.extend_=g}},_extendStyle:function(a){var b=this._g(a,"navNum");if(b==="pyramid")this._pyramidStyle(a);else return}})